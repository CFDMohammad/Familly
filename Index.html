<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Merger with Error Logging</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <h1>PDF Merger with Error Logging</h1>
    <input type="file" id="fileInput" multiple accept=".pdf">
    <button onclick="mergePDFs()">Merge PDFs</button>
    <p id="status"></p>
    <pre id="errorLog" style="color: red;"></pre>

    <script>
        async function mergePDFs() {
            const fileInput = document.getElementById('fileInput');
            const statusElement = document.getElementById('status');
            const errorLogElement = document.getElementById('errorLog');
            const files = fileInput.files;
            
            if (files.length < 2) {
                alert('Please select at least two PDF files to merge.');
                return;
            }

            statusElement.textContent = 'Processing... Please wait.';
            errorLogElement.textContent = '';

            try {
                const mergedPdf = new jspdf.jsPDF();
                
                for (let i = 0; i < files.length; i++) {
                    statusElement.textContent = `Processing file ${i + 1} of ${files.length}...`;
                    const file = files[i];
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                        
                        for (let j = 1; j <= pdf.numPages; j++) {
                            const page = await pdf.getPage(j);
                            const scale = 1.5; // Reduced scale to lower memory usage
                            const viewport = page.getViewport({ scale: scale });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            
                            if (i > 0 || j > 1) {
                                mergedPdf.addPage([viewport.width / scale, viewport.height / scale]);
                            } else {
                                mergedPdf.setPageSize([viewport.width / scale, viewport.height / scale]);
                            }
                            mergedPdf.addImage(canvas.toDataURL('image/jpeg', 0.8), 'JPEG', 0, 0, viewport.width / scale, viewport.height / scale);
                        }
                    } catch (fileError) {
                        errorLogElement.textContent += `Error processing file ${i + 1}: ${fileError.message}\n`;
                    }
                }
                
                statusElement.textContent = 'Generating download link...';
                const pdfBlob = mergedPdf.output('blob');
                const url = URL.createObjectURL(pdfBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'merged.pdf';
                link.click();
                URL.revokeObjectURL(url);
                statusElement.textContent = 'Merge complete! Check your downloads folder.';
            } catch (error) {
                console.error('Error merging PDFs:', error);
                errorLogElement.textContent += `General error: ${error.message}\n`;
                statusElement.textContent = 'An error occurred while merging PDFs. Please check the error log below.';
            }
        }
    </script>
</body>
</html>
